<Window x:Class="GCodeSimulator.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:hx="http://helix-toolkit.org/wpf"
        xmlns:avalonEdit="http://icsharpcode.net/sharpdevelop/avalonedit"
        xmlns:local="clr-namespace:GCodeSimulator"
        xmlns:helpers="clr-namespace:GCodeSimulator.Helpers"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}" Height="600" Width="1000"
        Closing="Window_Closing">

    <Window.Resources>
        <helpers:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <Style TargetType="Button">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Padding" Value="10,5"/>
        </Style>
        <Style TargetType="TextBlock">
            <Setter Property="Margin" Value="5"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="350"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Left Control Panel -->
        <Grid Grid.Column="0" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- File Buttons -->
            <StackPanel Grid.Row="0" Orientation="Horizontal">
                <Button Content="파일 열기" Command="{Binding LoadFileCommand}"/>
                <Button Content="DWG 열기" Command="{Binding LoadDwgFileCommand}"/>
                <Button Content="SAVE" Command="{Binding SaveFileCommand}"/>
                <Button Content="SAVE AS" Command="{Binding SaveAsCommand}" Width="84"/>
            </StackPanel>

            <!-- Simulation and View Controls -->
            <TabControl Grid.Row="1">
                <TabItem Header="시뮬레이션">
                    <GroupBox Header="시뮬레이션 컨트롤" Margin="0,10" BorderThickness="0">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <Button Content="{Binding PlayPauseButtonText}" Command="{Binding PlayPauseCommand}" Width="100"/>
                                <Button Content="처음으로" Command="{Binding ResetCommand}" Width="100"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="5">
                                <TextBlock Text="재생 속도:" Width="70"/>
                                <Slider Minimum="1" Maximum="10" Value="{Binding PlaybackSpeed, Mode=TwoWay}" Width="150" VerticalAlignment="Center" TickFrequency="1" IsSnapToTickEnabled="True"/>
                                <TextBlock Text="{Binding PlaybackSpeed, StringFormat={}{0:F0}x}" Width="30" Margin="5,0"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="5">
                                <TextBlock Text="단계:" Width="70"/>
                                <Slider Minimum="0" Maximum="{Binding MaxSteps}" Value="{Binding CurrentSegmentIndex, Mode=TwoWay}" Width="150" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding CurrentStepDisplay}" Width="80" Margin="5,0"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>
                </TabItem>
                <TabItem Header="뷰">
                    <GroupBox Header="뷰 컨트롤" Margin="0,10" BorderThickness="0">
                        <StackPanel>
                            <!-- 뷰 모드 선택 -->
                            <TextBlock Text="뷰 모드:" FontWeight="Bold" Margin="5,5,5,0"/>
                            <StackPanel Margin="10,5">
                                <RadioButton Content="자동 (Z축에 따라 2D/3D 전환)"
                                             IsChecked="{Binding IsAutoMode, Mode=TwoWay}"
                                             Margin="0,3"
                                             GroupName="ViewMode"/>
                                <RadioButton Content="2D 뷰 (XY 평면만 표시)"
                                             IsChecked="{Binding Is2DMode, Mode=TwoWay}"
                                             Margin="0,3"
                                             GroupName="ViewMode"/>
                                <RadioButton Content="3D 뷰"
                                             IsChecked="{Binding Is3DMode, Mode=TwoWay}"
                                             Margin="0,3"
                                             GroupName="ViewMode"/>
                            </StackPanel>

                            <!-- 구분선 -->
                            <Separator Margin="5,10"/>

                            <!-- 3D 그리드 설정 -->
                            <TextBlock Text="3D 그리드 설정:" FontWeight="Bold" Margin="5,5,5,0"/>
                            <CheckBox Content="그리드 표시" IsChecked="{Binding IsGridVisible, Mode=TwoWay}" Margin="10,5"/>
                            <StackPanel Orientation="Horizontal" Margin="10,5" IsEnabled="{Binding IsGridVisible}">
                                <TextBlock Text="보조 간격 (mm):" Width="100"/>
                                <TextBox Text="{Binding MinorGridDistance, UpdateSourceTrigger=PropertyChanged}" Width="50"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>
                </TabItem>

                <TabItem Header="통계">
                    <GroupBox Header="상세 통계" Margin="0,10" BorderThickness="0">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <TextBlock Text="가공 시간 통계" FontWeight="Bold" FontSize="12" Margin="5,5,5,10" Foreground="DarkBlue"/>

                                <Grid Margin="10,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="총 가공 시간:" Margin="0,3"/>
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding TotalMachiningTimeDisplay}" FontWeight="Bold" Margin="5,3"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="경과 시간:" Margin="0,3"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding ElapsedMachiningTimeDisplay}" Foreground="Blue" Margin="5,3"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="남은 시간:" Margin="0,3"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding RemainingMachiningTimeDisplay}" Foreground="Green" Margin="5,3"/>

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="진행률:" Margin="0,3"/>
                                    <StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal" Margin="5,3">
                                        <TextBlock Text="{Binding MachiningProgressDisplay}" FontWeight="Bold" Foreground="DarkRed" Margin="0,0,10,0"/>
                                        <ProgressBar Value="{Binding MachiningProgress, Mode=OneWay}" Width="120" Height="16" Minimum="0" Maximum="100"/>
                                    </StackPanel>
                                </Grid>

                                <Separator Margin="5,10"/>

                                <TextBlock Text="거리 통계" FontWeight="Bold" FontSize="12" Margin="5,5,5,10" Foreground="DarkBlue"/>

                                <Grid Margin="10,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="총 이동 거리:" Margin="0,3"/>
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding TotalDistanceDisplay}" FontWeight="Bold" Margin="5,3"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="급속 이송:" Margin="0,3"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding RapidDistanceDisplay}" Foreground="Blue" Margin="5,3"/>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="절삭 거리:" Margin="0,3"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding CuttingDistanceDisplay}" Foreground="Red" Margin="5,3"/>

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="원호 거리:" Margin="0,3"/>
                                    <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding ArcDistanceDisplay}" Foreground="Green" Margin="5,3"/>
                                </Grid>

                                <Separator Margin="5,10"/>

                                <TextBlock Text="경로 정보" FontWeight="Bold" FontSize="12" Margin="5,5,5,10" Foreground="DarkBlue"/>

                                <Grid Margin="10,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="120"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="총 경로 수:" Margin="0,3"/>
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding MaxSteps}" FontWeight="Bold" Margin="5,3"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="현재 단계:" Margin="0,3"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding CurrentStepDisplay}" Margin="5,3"/>
                                </Grid>
                            </StackPanel>
                        </ScrollViewer>
                    </GroupBox>
                </TabItem>

            </TabControl>
            
            <!-- G-Code Editor -->
            <GroupBox Grid.Row="2" Header="G-Code 편집" Margin="0,10">
                <avalonEdit:TextEditor x:Name="GCodeEditor"
                                       FontFamily="Consolas"
                                       FontSize="12"
                                       ShowLineNumbers="True"
                                       WordWrap="False"
                                       VerticalScrollBarVisibility="Auto"
                                       HorizontalScrollBarVisibility="Auto"/>
            </GroupBox>

            <!-- Current G-Code Line Display -->
            <GroupBox Grid.Row="3" Header="현재 실행 중인 코드" Margin="0,10">
                <StackPanel>
                    <TextBlock Text="{Binding CurrentLineDisplay}" FontWeight="Bold" FontSize="12" Margin="5"/>
                    <TextBlock Text="{Binding CurrentGCodeLine}"
                               FontFamily="Consolas"
                               FontSize="11"
                               Margin="5,0,5,5"
                               TextWrapping="Wrap"
                               Foreground="DarkBlue"/>
                </StackPanel>
            </GroupBox>

            <!-- Status Display -->
            <GroupBox Grid.Row="4" Header="정보" Margin="0,10">
                <StackPanel>
                    <TextBlock Text="{Binding StatusText}" TextWrapping="Wrap" FontSize="11" Margin="5"/>

                    <StackPanel Orientation="Horizontal" Margin="5">
                        <TextBlock Text="현재 피드 속도:" FontWeight="Bold" FontSize="11" Width="100"/>
                        <TextBlock Text="{Binding CurrentFeedRateDisplay}" FontSize="11"/>
                    </StackPanel>

                    <Separator Margin="5,5"/>

                    <TextBlock Text="가공 시간:" FontWeight="Bold" FontSize="11" Margin="5,5,5,0"/>
                    <StackPanel Orientation="Horizontal" Margin="10,2">
                        <TextBlock Text="총:" Width="60" FontSize="10"/>
                        <TextBlock Text="{Binding TotalMachiningTimeDisplay}" FontSize="10" FontWeight="Bold"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="10,2">
                        <TextBlock Text="경과:" Width="60" FontSize="10"/>
                        <TextBlock Text="{Binding ElapsedMachiningTimeDisplay}" FontSize="10" Foreground="Blue"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="10,2">
                        <TextBlock Text="남은 시간:" Width="60" FontSize="10"/>
                        <TextBlock Text="{Binding RemainingMachiningTimeDisplay}" FontSize="10" Foreground="Green"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="10,2">
                        <TextBlock Text="진행률:" Width="60" FontSize="10"/>
                        <TextBlock Text="{Binding MachiningProgressDisplay}" FontSize="10" FontWeight="Bold" Foreground="DarkRed"/>
                    </StackPanel>

                    <Separator Margin="5,5"/>

                    <TextBlock Text="이동 거리:" FontWeight="Bold" FontSize="11" Margin="5,5,5,0"/>
                    <StackPanel Orientation="Horizontal" Margin="10,2">
                        <TextBlock Text="총:" Width="60" FontSize="10"/>
                        <TextBlock Text="{Binding TotalDistanceDisplay}" FontSize="10" FontWeight="Bold"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="10,2">
                        <TextBlock Text="급속 이송:" Width="60" FontSize="10"/>
                        <TextBlock Text="{Binding RapidDistanceDisplay}" FontSize="10" Foreground="Blue"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="10,2">
                        <TextBlock Text="절삭:" Width="60" FontSize="10"/>
                        <TextBlock Text="{Binding CuttingDistanceDisplay}" FontSize="10" Foreground="Red"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="10,2">
                        <TextBlock Text="원호:" Width="60" FontSize="10"/>
                        <TextBlock Text="{Binding ArcDistanceDisplay}" FontSize="10" Foreground="Green"/>
                    </StackPanel>
                </StackPanel>
            </GroupBox>
        </Grid>

        <!-- Right Visualization Area -->
        <Grid Grid.Column="1" Margin="10">
            <Border BorderBrush="Gray" BorderThickness="1">
                <Grid>
                    <!-- 2D Canvas -->
                    <Canvas x:Name="Canvas2D"
                            Background="White"
                            Visibility="Collapsed"
                            ClipToBounds="True"/>

                    <!-- 3D Viewport -->
                    <hx:HelixViewport3D x:Name="Viewport3D" ShowCoordinateSystem="True" Visibility="Collapsed">
                        <hx:DefaultLights/>
                        <hx:GridLinesVisual3D
                            x:Name="GridLines3D"
                            Width="2000"
                            Length="2000"
                            Center="{Binding ModelCenter}"
                            Normal="0,0,1"
                            MinorDistance="{Binding MinorGridDistance}"
                            MajorDistance="{Binding MajorGridDistance}"
                            Thickness="0.05"
                            />
                    </hx:HelixViewport3D>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>
